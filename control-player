return function()
    local Players = game:GetService('Players')
    local ReplicatedStorage = game:GetService('ReplicatedStorage')
    local RunService = game:GetService('RunService')
    local UserInputService = game:GetService('UserInputService')
    local TweenService = game:GetService('TweenService')

    -- Переменные для хранения состояния
    local originalCharacter = nil
    local originalCameraSettings = {}
    local isControlling = false
    local countdownCoroutine = nil
    local originalHumanoidState = nil
    local webSlingerTool = nil

    -- Функция для поиска WebSlinger в инвентаре и выбора его слота
    local function selectWebSlingerSlot()
        local localPlayer = Players.LocalPlayer
        local character = localPlayer.Character

        if not character then
            return false
        end

        -- Ищем WebSlinger в руках персонажа
        for _, tool in ipairs(character:GetChildren()) do
            if
                tool:IsA('Tool')
                and (
                    tool.Name:lower():find('web')
                    or tool.Name:lower():find('slinger')
                    or tool.Name:lower():find('shooter')
                    or tool.Name:lower():find('swing')
                )
            then
                webSlingerTool = tool
                return true
            end
        end

        -- Ищем WebSlinger в бэкпаке
        local backpack = localPlayer:FindFirstChild('Backpack')
        if backpack then
            for _, tool in ipairs(backpack:GetChildren()) do
                if
                    tool:IsA('Tool')
                    and (
                        tool.Name:lower():find('web')
                        or tool.Name:lower():find('slinger')
                        or tool.Name:lower():find('shooter')
                        or tool.Name:lower():find('swing')
                    )
                then
                    webSlingerTool = tool
                    -- Экипируем WebSlinger
                    tool.Parent = character
                    local humanoid = character:FindFirstChild('Humanoid')
                    if humanoid then
                        humanoid:EquipTool(tool)
                    end
                    return true
                end
            end
        end

        return false
    end

    -- Функция для остановки движения персонажа
    local function stopCharacterMovement(character)
        if not character then
            return
        end

        local humanoid = character:FindFirstChild('Humanoid')
        local humanoidRootPart = character:FindFirstChild('HumanoidRootPart')
        if not humanoid or not humanoidRootPart then
            return
        end

        humanoid:MoveTo(humanoidRootPart.Position)
        humanoid.WalkSpeed = 0
    end

    -- Функция для восстановления движения персонажа
    local function restoreCharacterMovement(character)
        if not character then
            return
        end

        local humanoid = character:FindFirstChild('Humanoid')
        if not humanoid then
            return
        end

        humanoid.WalkSpeed = 16 -- Стандартная скорость
    end

    -- Функция для изменения WebRopes
    local function modifyWebRopes()
        local modifiedCount = 0
        for _, object in ipairs(workspace:GetDescendants()) do
            if
                object:IsA('RopeConstraint') and object.Name:lower():find('web')
            then
                object.Length = 950
                modifiedCount = modifiedCount + 1
            end
        end
        return modifiedCount
    end

    -- Функция для поиска ближайшего игрока в радиусе 20 studs
    local function findNearestPlayerInRange()
        local localPlayer = Players.LocalPlayer
        local localCharacter = localPlayer.Character
        if not localCharacter then
            return nil
        end

        local localRoot = localCharacter:FindFirstChild('HumanoidRootPart')
        if not localRoot then
            return nil
        end

        local nearestPlayer = nil
        local shortestDistance = math.huge
        local maxDistance = 20

        for _, player in pairs(Players:GetPlayers()) do
            if player ~= localPlayer and player.Character then
                local character = player.Character
                local humanoidRootPart =
                    character:FindFirstChild('HumanoidRootPart')
                if humanoidRootPart then
                    local distance = (
                        localRoot.Position - humanoidRootPart.Position
                    ).Magnitude
                    if
                        distance < shortestDistance
                        and distance <= maxDistance
                    then
                        shortestDistance = distance
                        nearestPlayer = player
                    end
                end
            end
        end

        return nearestPlayer
    end

    -- Функция для поиска игрока, в которого мы выстрелили
    local function findShotPlayer()
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= Players.LocalPlayer and player.Character then
                local humanoid = player.Character:FindFirstChild('Humanoid')
                if humanoid and humanoid.PlatformStand then
                    return player
                end
            end
        end
        return nil
    end

    -- Функция для отключения PlatformStand у цели
    local function disablePlatformStand(targetPlayer)
        if targetPlayer and targetPlayer.Character then
            local humanoid = targetPlayer.Character:FindFirstChild('Humanoid')
            if humanoid then
                humanoid.PlatformStand = false
            end
        end
    end

    -- Функция для смены персонажа
    local function swapCharacter(targetPlayer)
        local localPlayer = Players.LocalPlayer

        originalCharacter = localPlayer.Character
        originalCameraSettings = {
            CameraType = workspace.CurrentCamera.CameraType,
            CameraSubject = workspace.CurrentCamera.CameraSubject,
        }

        stopCharacterMovement(originalCharacter)
        disablePlatformStand(targetPlayer)

        -- Меняем персонажа
        localPlayer.Character = targetPlayer.Character

        wait(0.5)

        workspace.CurrentCamera.CameraType = originalCameraSettings.CameraType
        if targetPlayer.Character:FindFirstChild('Humanoid') then
            workspace.CurrentCamera.CameraSubject =
                targetPlayer.Character.Humanoid
        end

        spawn(modifyWebRopes)
    end

    -- Функция для возврата к оригинальному персонажу
    local function returnToOriginalCharacter()
        if not originalCharacter then
            return
        end

        local localPlayer = Players.LocalPlayer

        -- Возвращаем оригинального персонажа
        localPlayer.Character = originalCharacter

        -- Ждем загрузки персонажа
        wait(0.5)

        restoreCharacterMovement(originalCharacter)

        workspace.CurrentCamera.CameraType = originalCameraSettings.CameraType
        if originalCharacter:FindFirstChild('Humanoid') then
            workspace.CurrentCamera.CameraSubject = originalCharacter.Humanoid
        end

        originalCharacter = nil
        originalCameraSettings = {}
        isControlling = false
        webSlingerTool = nil
    end

    -- Функция для остановки таймера
    local function stopCountdown()
        if countdownCoroutine then
            coroutine.close(countdownCoroutine)
            countdownCoroutine = nil
        end
    end

    -- Создание GUI
    local player = Players.LocalPlayer
    local screenGui = Instance.new('ScreenGui')
    screenGui.Name = 'ControlPlayerMenu'
    screenGui.Parent = player:WaitForChild('PlayerGui')
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local controlButton = Instance.new('TextButton')
    controlButton.Size = UDim2.new(0, 150, 0, 40)
    controlButton.Position = UDim2.new(0, 10, 0, 10)
    controlButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    controlButton.BorderSizePixel = 0
    controlButton.Text = 'CONTROL PLAYER (F)'
    controlButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    controlButton.Font = Enum.Font.Code
    controlButton.TextSize = 14
    controlButton.Parent = screenGui

    local controlButtonCorner = Instance.new('UICorner')
    controlButtonCorner.CornerRadius = UDim.new(0, 6)
    controlButtonCorner.Parent = controlButton

    local controlButtonStroke = Instance.new('UIStroke')
    controlButtonStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    controlButtonStroke.Color = Color3.fromRGB(50, 50, 50)
    controlButtonStroke.Thickness = 2
    controlButtonStroke.LineJoinMode = Enum.LineJoinMode.Round
    controlButtonStroke.Parent = controlButton

    -- Эффект при наведении на кнопку
    controlButton.MouseEnter:Connect(function()
        TweenService:Create(
            controlButton,
            TweenInfo.new(0.2),
            { BackgroundColor3 = Color3.fromRGB(35, 35, 35) }
        ):Play()
    end)

    controlButton.MouseLeave:Connect(function()
        TweenService:Create(
            controlButton,
            TweenInfo.new(0.2),
            { BackgroundColor3 = Color3.fromRGB(25, 25, 25) }
        ):Play()
    end)

    -- Функция перетаскивания
    local dragging = false
    local dragStart, startPos

    local function update(input)
        if not dragging then
            return
        end

        local delta = input.Position - dragStart
        local newX = startPos.X.Offset + delta.X
        local newY = startPos.Y.Offset + delta.Y

        newX = math.clamp(
            newX,
            0,
            screenGui.AbsoluteSize.X - controlButton.AbsoluteSize.X
        )
        newY = math.clamp(
            newY,
            0,
            screenGui.AbsoluteSize.Y - controlButton.AbsoluteSize.Y
        )

        controlButton.Position = UDim2.new(0, newX, 0, newY)
    end

    controlButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = controlButton.Position
        end
    end)

    controlButton.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if
            input.UserInputType == Enum.UserInputType.MouseMovement and dragging
        then
            update(input)
        end
    end)

    -- Основная функция контроля игрока
    local function controlPlayer()
        if isControlling then
            -- Отмена контроля
            stopCountdown()
            returnToOriginalCharacter()
            controlButton.Text = 'CONTROL PLAYER (F)'
            controlButton.TextColor3 = Color3.fromRGB(255, 255, 255)
            controlButtonStroke.Color = Color3.fromRGB(50, 50, 50)
        else
            -- Начинаем контроль
            controlButton.Text = 'Selecting WebSlinger...'

            -- Просто выбираем слот с WebSlinger
            if selectWebSlingerSlot() then
                controlButton.Text = 'Finding target...'
                local nearestPlayer = findNearestPlayerInRange()

                if nearestPlayer and nearestPlayer.Character then
                    local targetRoot = nearestPlayer.Character:FindFirstChild(
                        'HumanoidRootPart'
                    )
                    if targetRoot then
                        controlButton.Text = 'Shooting...'

                        -- Выстрел WebSlinger
                        local Event =
                            ReplicatedStorage.Packages.Net['RE/UseItem']
                        Event:FireServer(
                            Vector3.new(
                                -450.30258178711,
                                -7.0001068115234,
                                1.8120102882385
                            ),
                            targetRoot
                        )

                        controlButton.Text = 'Checking hit...'
                        
                        -- Ждем проверку попадания, но не добавляем это время к таймеру
                        local startTime = tick()
                        local shotPlayer = nil
                        
                        -- Проверяем попадание в течение 1 секунды, но не блокируем выполнение
                        while tick() - startTime < 1 and not shotPlayer do
                            shotPlayer = findShotPlayer()
                            wait(0.1)
                        end

                        if shotPlayer then
                            -- Успешное попадание
                            swapCharacter(shotPlayer)
                            isControlling = true
                            controlButton.Text = 'CANCEL (10s)'
                            controlButton.TextColor3 =
                                Color3.fromRGB(255, 100, 100)
                            controlButtonStroke.Color =
                                Color3.fromRGB(255, 100, 100)

                            -- Таймер на 10 секунд (точно 10 секунд)
                            local timer = 10
                            local timerStart = tick()
                            countdownCoroutine = coroutine.create(function()
                                while timer > 0 and isControlling do
                                    local elapsed = tick() - timerStart
                                    timer = 10 - math.floor(elapsed)
                                    if timer < 0 then timer = 0 end
                                    controlButton.Text = 'CANCEL ('
                                        .. timer
                                        .. 's)'
                                    wait(0.1)
                                end

                                if isControlling then
                                    -- Автоматический возврат
                                    returnToOriginalCharacter()
                                    controlButton.Text = 'CONTROL PLAYER (F)'
                                    controlButton.TextColor3 =
                                        Color3.fromRGB(255, 255, 255)
                                    controlButtonStroke.Color =
                                        Color3.fromRGB(50, 50, 50)
                                end
                            end)
                            coroutine.resume(countdownCoroutine)
                        else
                            -- Промах
                            controlButton.Text = 'MISSED!'
                            wait(1)
                            controlButton.Text = 'CONTROL PLAYER (F)'
                        end
                    else
                        -- Ошибка
                        controlButton.Text = 'ERROR!'
                        wait(1)
                        controlButton.Text = 'CONTROL PLAYER (F)'
                    end
                else
                    -- Никого нет рядом
                    controlButton.Text = 'No target nearby!'
                    wait(1)
                    controlButton.Text = 'CONTROL PLAYER (F)'
                end
            else
                -- WebSlinger не найден
                controlButton.Text = 'No WebSlinger found!'
                wait(1)
                controlButton.Text = 'CONTROL PLAYER (F)'
            end
        end
    end

    -- Обработчик нажатия кнопки
    controlButton.MouseButton1Click:Connect(controlPlayer)

    -- Обработчик клавиши F
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then
            return
        end

        if input.KeyCode == Enum.KeyCode.F then
            controlPlayer()
        end
    end)

    -- Очистка при выходе
    player.CharacterRemoving:Connect(function()
        if isControlling then
            returnToOriginalCharacter()
        end
    end)

    screenGui.Destroying:Connect(function()
        if isControlling then
            returnToOriginalCharacter()
        end
    end)
end
