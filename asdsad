local Players = game:GetService('Players')
local ReplicatedStorage = game:GetService('ReplicatedStorage')
local RunService = game:GetService('RunService')
local UserInputService = game:GetService('UserInputService')
local TweenService = game:GetService('TweenService')

-- Переменные для хранения состояния
local originalCharacter = nil
local originalCameraSettings = {}
local isControlling = false
local countdownCoroutine = nil
local currentTools = {}
local originalHumanoidState = nil
local anchoredParts = {} -- Таблица для хранения заанкоренных частей

-- Функция для изменения WebRopes
local function modifyWebRopes()
    local workspaceObjects = workspace:GetDescendants()
    local modifiedCount = 0

    for _, object in ipairs(workspaceObjects) do
        if object:IsA('RopeConstraint') and object.Name:lower():find('web') then
            object.Length = 950
            modifiedCount = modifiedCount + 1
        end
    end

    return modifiedCount
end

-- Функция для убирания всех инструментов из рук
local function unequipAllTools()
    local localPlayer = Players.LocalPlayer
    local character = localPlayer.Character
    if not character then return end
    
    local backpack = localPlayer:FindFirstChild('Backpack')
    if not backpack then return end
    
    currentTools = {}
    for _, tool in ipairs(character:GetChildren()) do
        if tool:IsA('Tool') then
            table.insert(currentTools, tool)
            tool.Parent = backpack
        end
    end
end

-- Функция для возврата инструментов в руки
local function reequipTools()
    local localPlayer = Players.LocalPlayer
    local character = localPlayer.Character
    if not character then return end
    
    for _, tool in ipairs(currentTools) do
        if tool and tool.Parent then
            tool.Parent = character
        end
    end
    currentTools = {}
end

-- Функция для заморозки оригинального персонажа
local function freezeOriginalCharacter(character)
    if not character then return end
    
    local humanoid = character:FindFirstChild('Humanoid')
    if not humanoid then return end
    
    originalHumanoidState = {
        WalkSpeed = humanoid.WalkSpeed,
        JumpPower = humanoid.JumpPower,
        PlatformStand = humanoid.PlatformStand
    }
    
    humanoid.WalkSpeed = 0
    humanoid.JumpPower = 0
    humanoid.PlatformStand = true
    
    -- Сохраняем ссылки на заанкоренные части
    anchoredParts = {}
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA('BasePart') then
            table.insert(anchoredParts, part)
            part.Anchored = true
        end
    end
end

-- Функция для разморозки оригинального персонажа
local function unfreezeOriginalCharacter(character)
    if not character or not originalHumanoidState then return end
    
    local humanoid = character:FindFirstChild('Humanoid')
    if not humanoid then return end
    
    humanoid.WalkSpeed = originalHumanoidState.WalkSpeed
    humanoid.JumpPower = originalHumanoidState.JumpPower
    humanoid.PlatformStand = originalHumanoidState.PlatformStand
    
    -- Убираем Anchored со всех частей, которые были заанкорены
    for _, part in ipairs(anchoredParts) do
        if part and part:IsA('BasePart') then
            part.Anchored = false
        end
    end
    anchoredParts = {}
    
    originalHumanoidState = nil
end

-- Быстрый поиск Web Slinger
local function findWebSlingerQuick()
    local localPlayer = Players.LocalPlayer
    local backpack = localPlayer:FindFirstChild('Backpack')
    if not backpack then return nil end

    for _, item in ipairs(backpack:GetChildren()) do
        if item:IsA('Tool') and (item.Name:lower():find('web') or item.Name:lower():find('slinger') or item.Name:lower():find('shooter') or item.Name:lower():find('swing')) then
            return item
        end
    end
    return nil
end

-- Мгновенное взятие Web Slinger
local function takeWebSlingerInstantly()
    local webSlinger = findWebSlingerQuick()
    if not webSlinger then return false end
    
    unequipAllTools()
    webSlinger.Parent = Players.LocalPlayer.Character
    return true
end

-- Быстрый поиск ближайшего игрока
local function findNearestPlayerQuick()
    local localPlayer = Players.LocalPlayer
    local localCharacter = localPlayer.Character
    if not localCharacter then return nil end

    local localRoot = localCharacter:FindFirstChild('HumanoidRootPart')
    if not localRoot then return nil end

    local nearestPlayer = nil
    local shortestDistance = math.huge
    local maxDistance = 20

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            local character = player.Character
            local humanoidRootPart = character:FindFirstChild('HumanoidRootPart')

            if humanoidRootPart then
                local distance = (localRoot.Position - humanoidRootPart.Position).Magnitude
                if distance < shortestDistance and distance <= maxDistance then
                    shortestDistance = distance
                    nearestPlayer = player
                end
            end
        end
    end

    return nearestPlayer
end

-- Мгновенное вселение в цель
local function possessTargetInstantly(targetPlayer)
    if not targetPlayer or not targetPlayer.Character then return false end
    
    local localPlayer = Players.LocalPlayer
    
    -- Сохраняем оригинального персонажа
    originalCharacter = localPlayer.Character
    originalCameraSettings = {
        CameraType = workspace.CurrentCamera.CameraType,
        CameraSubject = workspace.CurrentCamera.CameraSubject,
    }
    
    -- Замораживаем оригинального персонажа
    freezeOriginalCharacter(originalCharacter)
    
    -- Мгновенно вселяемся в цель
    localPlayer.Character = targetPlayer.Character
    
    -- Мгновенно настраиваем камеру
    workspace.CurrentCamera.CameraSubject = targetPlayer.Character:FindFirstChild('Humanoid')
    
    return true
end

-- Мгновенный выстрел и вселение
local function shootAndPossessInstantly(targetPlayer)
    if not targetPlayer or not targetPlayer.Character then return false end
    
    local targetRoot = targetPlayer.Character:FindFirstChild('HumanoidRootPart')
    if not targetRoot then return false end
    
    -- Мгновенный выстрел
    local Event = ReplicatedStorage.Packages.Net['RE/UseItem']
    Event:FireServer(
        Vector3.new(-450.30258178711, -7.0001068115234, 1.8120102882385),
        targetRoot
    )
    
    -- Мгновенное вселение
    task.wait(0.1) -- Минимальная задержка для обработки выстрела
    return possessTargetInstantly(targetPlayer)
end

-- Функция для возврата к оригинальному персонажу
local function returnToOriginalCharacter()
    if not originalCharacter then return end

    local localPlayer = Players.LocalPlayer
    localPlayer.Character = originalCharacter
    unfreezeOriginalCharacter(originalCharacter)
    
    workspace.CurrentCamera.CameraType = originalCameraSettings.CameraType
    workspace.CurrentCamera.CameraSubject = originalCharacter:FindFirstChild('Humanoid')
    
    reequipTools()
    
    originalCharacter = nil
    originalCameraSettings = {}
    isControlling = false
end

-- Функция для остановки таймера
local function stopCountdown()
    if countdownCoroutine then
        coroutine.close(countdownCoroutine)
        countdownCoroutine = nil
    end
end

-- Создание GUI
local player = Players.LocalPlayer
local mainColor = Color3.fromRGB(25, 25, 25)
local textColor = Color3.fromRGB(255, 255, 255)
local borderColor = Color3.fromRGB(50, 50, 50)

local screenGui = Instance.new('ScreenGui')
screenGui.Name = 'ControlPlayerMenu'
screenGui.Parent = player:WaitForChild('PlayerGui')
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Основная кнопка
local controlButton = Instance.new('TextButton')
controlButton.Size = UDim2.new(0, 150, 0, 40)
controlButton.Position = UDim2.new(0, 10, 0, 10)
controlButton.BackgroundColor3 = mainColor
controlButton.BorderSizePixel = 0
controlButton.Text = 'CONTROL PLAYER'
controlButton.TextColor3 = textColor
controlButton.Font = Enum.Font.Code
controlButton.TextSize = 14
controlButton.Parent = screenGui

local controlButtonCorner = Instance.new('UICorner')
controlButtonCorner.CornerRadius = UDim.new(0, 6)
controlButtonCorner.Parent = controlButton

local controlButtonStroke = Instance.new('UIStroke')
controlButtonStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
controlButtonStroke.Color = borderColor
controlButtonStroke.Thickness = 2
controlButtonStroke.LineJoinMode = Enum.LineJoinMode.Round
controlButtonStroke.Parent = controlButton

-- Эффект при наведении на кнопку
controlButton.MouseEnter:Connect(function()
    TweenService:Create(
        controlButton,
        TweenInfo.new(0.1),
        {BackgroundColor3 = Color3.fromRGB(35, 35, 35)}
    ):Play()
end)

controlButton.MouseLeave:Connect(function()
    TweenService:Create(
        controlButton,
        TweenInfo.new(0.1),
        {BackgroundColor3 = mainColor}
    ):Play()
end)

-- Функция перетаскивания
local dragging = false
local dragStart, startPos

local function update(input)
    if not dragging then return end
    local delta = input.Position - dragStart
    local newX = startPos.X.Offset + delta.X
    local newY = startPos.Y.Offset + delta.Y
    newX = math.clamp(newX, 0, screenGui.AbsoluteSize.X - controlButton.AbsoluteSize.X)
    newY = math.clamp(newY, 0, screenGui.AbsoluteSize.Y - controlButton.AbsoluteSize.Y)
    controlButton.Position = UDim2.new(0, newX, 0, newY)
end

controlButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = controlButton.Position
    end
end)

controlButton.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
        update(input)
    end
end)

-- Обработчик нажатия кнопки
controlButton.MouseButton1Click:Connect(function()
    if isControlling then
        stopCountdown()
        returnToOriginalCharacter()
        controlButton.Text = 'CONTROL PLAYER'
        controlButton.TextColor3 = textColor
        controlButtonStroke.Color = borderColor
    else
        -- Мгновенный процесс: взятие Web Slinger → поиск цели → выстрел → вселение
        controlButton.Text = 'TAKING WEB...'
        
        if not takeWebSlingerInstantly() then
            controlButton.Text = 'CONTROL PLAYER'
            reequipTools()
            return
        end

        controlButton.Text = 'FINDING TARGET...'
        local targetPlayer = findNearestPlayerQuick()
        
        if not targetPlayer then
            controlButton.Text = 'CONTROL PLAYER'
            reequipTools()
            return
        end

        controlButton.Text = 'SHOOTING...'
        
        -- Мгновенный выстрел и вселение
        if shootAndPossessInstantly(targetPlayer) then
            isControlling = true
            controlButton.Text = 'CANCEL (9s)'
            controlButton.TextColor3 = Color3.fromRGB(255, 100, 100)
            controlButtonStroke.Color = Color3.fromRGB(255, 100, 100)

            -- Быстрый таймер
            local timer = 9
            countdownCoroutine = coroutine.create(function()
                while timer > 0 and isControlling do
                    task.wait(1)
                    timer = timer - 1
                    controlButton.Text = 'CANCEL (' .. timer .. 's)'
                end

                if isControlling then
                    returnToOriginalCharacter()
                    controlButton.Text = 'CONTROL PLAYER'
                    controlButton.TextColor3 = textColor
                    controlButtonStroke.Color = borderColor
                end
            end)
            coroutine.resume(countdownCoroutine)
        else
            controlButton.Text = 'CONTROL PLAYER'
            reequipTools()
        end
    end
end)

-- Очистка
player.CharacterRemoving:Connect(function()
    if isControlling then
        returnToOriginalCharacter()
    else
        reequipTools()
    end
end)

screenGui.Destroying:Connect(function()
    if isControlling then
        returnToOriginalCharacter()
    else
        reequipTools()
    end
end)
