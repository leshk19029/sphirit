local Players = game:GetService('Players')
local RunService = game:GetService('RunService')
local Event = game:GetService('ReplicatedStorage').Packages.Net['RE/UseItem']

local player = Players.LocalPlayer
local isFiring = false
local fireRate = 50
local fireInterval = 1 / fireRate
local lastFireTime = 0
local equipConnection = nil
local spamConnection = nil
local spawnLoopRunning = false

local function getCharacter(p)
    if p and p.Character then
        return p.Character
    end
    return nil
end

local function getClosestPlayer()
    local localCharacter = getCharacter(player)
    if not localCharacter or not localCharacter:FindFirstChild('HumanoidRootPart') then
        return nil
    end

    local localRoot = localCharacter.HumanoidRootPart
    local closestPlayer = nil
    local closestDistance = math.huge

    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player then
            local character = getCharacter(p)
            if character and character:FindFirstChild('HumanoidRootPart') and character:FindFirstChild('UpperTorso') then
                local distance = (localRoot.Position - character.HumanoidRootPart.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = character
                end
            end
        end
    end

    return closestPlayer
end

local function spamEvent()
    local targetCharacter = getClosestPlayer()
    if targetCharacter and targetCharacter:FindFirstChild('UpperTorso') then
        local targetPosition = targetCharacter.UpperTorso.Position
        local success = pcall(function()
            Event:FireServer(
                targetPosition,
                targetCharacter.UpperTorso
            )
        end)
    end
end

local function takeLaserCape()
    local backpack = player:FindFirstChild('Backpack')
    if not backpack then
        return false
    end

    for _, tool in ipairs(backpack:GetChildren()) do
        if tool:IsA('Tool') and (tool.Name:lower():find('laser') and tool.Name:lower():find('cape')) then
            local character = player.Character
            if character then
                local humanoid = character:FindFirstChild('Humanoid')
                if humanoid then
                    humanoid:EquipTool(tool)
                    return true
                end
            end
        end
    end
    return false
end

local function startAutoEquip()
    if equipConnection then
        equipConnection:Disconnect()
    end

    equipConnection = RunService.Heartbeat:Connect(function()
        local character = player.Character
        if character then
            local hasLaserCape = false
            for _, tool in ipairs(character:GetChildren()) do
                if tool:IsA('Tool') and (tool.Name:lower():find('laser') and tool.Name:lower():find('cape')) then
                    hasLaserCape = true
                    break
                end
            end

            if not hasLaserCape then
                takeLaserCape()
            end
        end
    end)

    return function()
        if equipConnection then
            equipConnection:Disconnect()
            equipConnection = nil
        end
    end
end

local function startItemSpam(rate)
    if rate then
        fireRate = math.clamp(rate, 10, 60)
        fireInterval = 1 / fireRate
    end
    isFiring = true

    if spamConnection then
        spamConnection:Disconnect()
    end
    spamConnection = RunService.Heartbeat:Connect(function()
        if not isFiring then
            spamConnection:Disconnect()
            spamConnection = nil
            return
        end

        local currentTime = tick()
        if currentTime - lastFireTime >= fireInterval then
            lastFireTime = currentTime
            spamEvent()
        end
    end)

    if not spawnLoopRunning then
        spawnLoopRunning = true
        spawn(function()
            while spawnLoopRunning and isFiring do
                spamEvent()
                wait(fireInterval)
            end
            spawnLoopRunning = false
        end)
    end

    return function()
        isFiring = false
        if spamConnection then
            spamConnection:Disconnect()
            spamConnection = nil
        end
        spawnLoopRunning = false
    end
end

return {
    startItemSpam = startItemSpam,
    startAutoEquip = startAutoEquip,
    spamEvent = spamEvent,
    takeLaserCape = takeLaserCape
}
