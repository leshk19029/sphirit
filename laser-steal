local Players = game:GetService('Players')
local RunService = game:GetService('RunService')
local Event = game:GetService('ReplicatedStorage').Packages.Net['RE/UseItem']

local player = Players.LocalPlayer
local isFiring = false
local fireRate = 30 -- раз в секунду
local fireInterval = 1 / fireRate
local lastFireTime = 0
local equipConnection = nil

-- Функция для безопасного получения персонажа
local function getCharacter(player)
    if player and player.Character then
        return player.Character
    end
    return nil
end

-- Функция для получения случайного игрока
local function getRandomPlayer()
    local players = Players:GetPlayers()
    local validPlayers = {}

    for _, p in ipairs(players) do
        if p ~= Players.LocalPlayer then
            local character = getCharacter(p)
            if character and character:FindFirstChild('UpperTorso') then
                table.insert(validPlayers, character)
            end
        end
    end

    if #validPlayers > 0 then
        return validPlayers[math.random(1, #validPlayers)]
    end
    return nil
end

-- Функция для спама ивентами
local function spamEvent()
    local targetCharacter = getRandomPlayer()
    if targetCharacter and targetCharacter:FindFirstChild('UpperTorso') then
        local success, errorMsg = pcall(function()
            Event:FireServer(
                Vector3.new(-344.38818359375, 2.8618948459625, 35.521560668945),
                targetCharacter.UpperTorso
            )
        end)

        if not success then
            warn('Ошибка при вызове FireServer: ' .. errorMsg)
        end
    end
end

-- Функция для взятия Laser Cape
local function takeLaserCape()
    local backpack = player:FindFirstChild('Backpack')
    if not backpack then
        return false
    end

    for _, tool in ipairs(backpack:GetChildren()) do
        if tool:IsA('Tool') and (tool.Name:lower():find('laser') and tool.Name:lower():find('cape')) then
            local character = player.Character
            if character then
                local humanoid = character:FindFirstChild('Humanoid')
                if humanoid then
                    humanoid:EquipTool(tool)
                    return true
                end
            end
        end
    end
    return false
end

-- Запуск авто-экипировки
local function startAutoEquip()
    if equipConnection then
        equipConnection:Disconnect()
    end

    equipConnection = RunService.Heartbeat:Connect(function()
        local character = player.Character
        if character then
            local hasLaserCape = false
            for _, tool in ipairs(character:GetChildren()) do
                if tool:IsA('Tool') and (tool.Name:lower():find('laser') and tool.Name:lower():find('cape')) then
                    hasLaserCape = true
                    break
                end
            end

            if not hasLaserCape then
                takeLaserCape()
            end
        end
    end)

    return function()
        if equipConnection then
            equipConnection:Disconnect()
            equipConnection = nil
        end
    end
end

-- Основной цикл для спама
local function startItemSpam()
    local spamConnection
    spamConnection = RunService.Heartbeat:Connect(function()
        if not isFiring then
            spamConnection:Disconnect()
            return
        end

        local currentTime = tick()
        if currentTime - lastFireTime >= fireInterval then
            lastFireTime = currentTime
            spamEvent()
        end
    end)

    return function()
        if spamConnection then
            spamConnection:Disconnect()
        end
        isFiring = false
    end
end

-- Экспортируем функции
return {
    startItemSpam = startItemSpam,
    startAutoEquip = startAutoEquip,
    spamEvent = spamEvent,
    takeLaserCape = takeLaserCape
}
