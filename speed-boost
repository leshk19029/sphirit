local Players = game:GetService('Players')
local TweenService = game:GetService('TweenService')
local UserInputService = game:GetService('UserInputService')
local RunService = game:GetService('RunService')

return function()
    local player = Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:WaitForChild('Humanoid')

    -- Создаем основной GUI
    local ScreenGui = Instance.new('ScreenGui')
    ScreenGui.Name = 'SpeedControl'
    ScreenGui.Parent = player.PlayerGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- Контейнер для элементов (для удобного перемещения)
    local container = Instance.new('Frame')
    container.Size = UDim2.new(0, 200, 0, 40)
    container.Position = UDim2.new(0, 10, 0, 10)
    container.BackgroundTransparency = 1
    container.Parent = ScreenGui

    -- Основная кнопка
    local controlButton = Instance.new('TextButton')
    controlButton.Size = UDim2.new(0, 120, 0, 40)
    controlButton.Position = UDim2.new(0, 0, 0, 0)
    controlButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    controlButton.BorderSizePixel = 0
    controlButton.Text = 'SPEED: OFF'
    controlButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    controlButton.Font = Enum.Font.Code
    controlButton.TextSize = 14
    controlButton.Parent = container

    local controlButtonCorner = Instance.new('UICorner')
    controlButtonCorner.CornerRadius = UDim.new(0, 6)
    controlButtonCorner.Parent = controlButton

    local controlButtonStroke = Instance.new('UIStroke')
    controlButtonStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    controlButtonStroke.Color = Color3.fromRGB(50, 50, 50)
    controlButtonStroke.Thickness = 2
    controlButtonStroke.LineJoinMode = Enum.LineJoinMode.Round
    controlButtonStroke.Parent = controlButton

    -- Текстовое поле для ввода скорости
    local speedTextBox = Instance.new('TextBox')
    speedTextBox.Size = UDim2.new(0, 50, 0, 40)
    speedTextBox.Position = UDim2.new(0, 130, 0, 0)
    speedTextBox.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    speedTextBox.BorderSizePixel = 0
    speedTextBox.Text = '25'
    speedTextBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    speedTextBox.Font = Enum.Font.Code
    speedTextBox.TextSize = 14
    speedTextBox.PlaceholderText = 'Speed'
    speedTextBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    speedTextBox.TextXAlignment = Enum.TextXAlignment.Center
    speedTextBox.Parent = container

    local speedTextBoxCorner = Instance.new('UICorner')
    speedTextBoxCorner.CornerRadius = UDim.new(0, 6)
    speedTextBoxCorner.Parent = speedTextBox

    local speedTextBoxStroke = Instance.new('UIStroke')
    speedTextBoxStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    speedTextBoxStroke.Color = Color3.fromRGB(50, 50, 50)
    speedTextBoxStroke.Thickness = 2
    speedTextBoxStroke.LineJoinMode = Enum.LineJoinMode.Round
    speedTextBoxStroke.Parent = speedTextBox

    -- Кнопка для перемещения (невидимая область для перетаскивания)
    local dragHandle = Instance.new('TextButton')
    dragHandle.Size = UDim2.new(0, 20, 0, 20)
    dragHandle.Position = UDim2.new(0, 180, 0, 0)
    dragHandle.BackgroundTransparency = 1
    dragHandle.Text = "⤧"
    dragHandle.TextColor3 = Color3.fromRGB(150, 150, 150)
    dragHandle.Font = Enum.Font.Code
    dragHandle.TextSize = 12
    dragHandle.Parent = container

    -- Переменные состояния
    local speedEnabled = false
    local currentSpeed = 25
    local dragInput, dragStart, startPos

    -- Функция для применения скорости
    local function applyVelocity()
        if speedEnabled and character and humanoid then
            local rootPart = character:FindFirstChild('HumanoidRootPart')
            if rootPart then
                local moveDirection = humanoid.MoveDirection
                if moveDirection.Magnitude > 0 then
                    local velocity = moveDirection * currentSpeed
                    rootPart.Velocity = Vector3.new(velocity.X, rootPart.Velocity.Y, velocity.Z)
                end
            end
        end
    end

    -- Функция для обновления скорости из текстового поля
    local function updateSpeedFromTextBox()
        local text = speedTextBox.Text
        if text and text ~= "" then
            local newSpeed = tonumber(text)
            if newSpeed then
                if newSpeed > 45 then
                    currentSpeed = 45
                    speedTextBox.Text = "45"
                elseif newSpeed < 1 then
                    currentSpeed = 1
                    speedTextBox.Text = "1"
                else
                    currentSpeed = newSpeed
                end
            else
                speedTextBox.Text = tostring(currentSpeed)
            end
        end
    end

    -- Функция перетаскивания
    local function updateDrag(input)
        local delta = input.Position - dragStart
        local newX = startPos.X.Offset + delta.X
        local newY = startPos.Y.Offset + delta.Y

        -- Ограничиваем позицию в пределах экрана
        newX = math.clamp(newX, 0, ScreenGui.AbsoluteSize.X - container.AbsoluteSize.X)
        newY = math.clamp(newY, 0, ScreenGui.AbsoluteSize.Y - container.AbsoluteSize.Y)

        container.Position = UDim2.new(0, newX, 0, newY)
    end

    -- Обработчики событий для перетаскивания
    local function onInputBegan(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragStart = input.Position
            startPos = container.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragStart = nil
                end
            end)
        end
    end

    local function onInputChanged(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end

    -- Подключаем события перетаскивания к элементам
    dragHandle.InputBegan:Connect(onInputBegan)
    dragHandle.InputChanged:Connect(onInputChanged)
    
    controlButton.InputBegan:Connect(onInputBegan)
    controlButton.InputChanged:Connect(onInputChanged)
    
    speedTextBox.InputBegan:Connect(onInputBegan)
    speedTextBox.InputChanged:Connect(onInputChanged)

    -- Обработка перемещения мыши
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragStart then
            updateDrag(input)
        end
    end)

    -- Эффекты при наведении на кнопку перемещения
    dragHandle.MouseEnter:Connect(function()
        TweenService:Create(
            dragHandle,
            TweenInfo.new(0.2),
            {TextColor3 = Color3.fromRGB(255, 255, 255)}
        ):Play()
    end)

    dragHandle.MouseLeave:Connect(function()
        TweenService:Create(
            dragHandle,
            TweenInfo.new(0.2),
            {TextColor3 = Color3.fromRGB(150, 150, 150)}
        ):Play()
    end)

    -- Эффекты для основной кнопки
    controlButton.MouseEnter:Connect(function()
        TweenService:Create(
            controlButton,
            TweenInfo.new(0.2),
            {BackgroundColor3 = Color3.fromRGB(35, 35, 35)}
        ):Play()
    end)

    controlButton.MouseLeave:Connect(function()
        TweenService:Create(
            controlButton,
            TweenInfo.new(0.2),
            {BackgroundColor3 = Color3.fromRGB(25, 25, 25)}
        ):Play()
    end)

    -- Переключение скорости
    controlButton.MouseButton1Click:Connect(function()
        speedEnabled = not speedEnabled
        controlButton.Text = speedEnabled and 'SPEED: ON' or 'SPEED: OFF'
    end)

    -- Обновление скорости из текстового поля
    speedTextBox.FocusLost:Connect(function(enterPressed)
        updateSpeedFromTextBox()
    end)

    -- Применение скорости каждый кадр
    RunService.RenderStepped:Connect(applyVelocity)

    -- Функция очистки
    return function()
        ScreenGui:Destroy()
    end
end
